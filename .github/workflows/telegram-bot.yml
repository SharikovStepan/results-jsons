name: Telegram JSON Processor

on:
  repository_dispatch:
    types: [telegram_file]

jobs:
  process_file:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Process file
        id: process_file
        run: |
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
          sudo apt-get install -y jq

          # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–µ–±—Ö—É–∫–∞
          RAW_CONTENT='${{ toJson(github.event.client_payload.file_content) }}'
          CLEAN_CONTENT=$(echo "$RAW_CONTENT" | sed 's/\\"/"/g' | sed 's/^"\|"$//g')
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º caption
          CAPTION=$(echo "$CLEAN_CONTENT" | jq -r '.message.caption // "file"')
          # –ó–∞–º–µ–Ω—è–µ–º –ø—Ä–æ–±–µ–ª—ã, "_" –∏ "." –Ω–∞ "-"
          PROCESSED_CAPTION=$(echo "$CAPTION" | sed -e 's/[ _.]/-/g')
          FILE_ID=$(echo "$CLEAN_CONTENT" | jq -r '.message.document.file_id')
          ORIG_NAME=$(echo "$CLEAN_CONTENT" | jq -r '.message.document.file_name')

          # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
          FILE_PATH=$(curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/getFile?file_id=$FILE_ID" | jq -r '.result.file_path')
          curl -s -o "temp.json" "https://api.telegram.org/file/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/$FILE_PATH"

          # –ò–∑–≤–ª–µ–∫–∞–µ–º chat_id –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
          CHAT_ID=$(echo "$CLEAN_CONTENT" | jq -r '.message.chat.id')

          # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –¥–∞—Ç—É –∏–∑ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ JSON
          JSON_DATETIME=$(jq -r '
            [.heats | to_entries[] | 
              .value.rounds | to_entries[] | 
              .value.start_time_formatted
            ] | first // "null"' "temp.json")
          
          if [ "$JSON_DATETIME" != "null" ]; then
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è (—á–∞—Å—ã:–º–∏–Ω—É—Ç—ã)
            DATETIME=$(echo "$JSON_DATETIME" | 
                      sed -E 's/([0-9]{4}-[0-9]{2}-[0-9]{2}) ([0-9]{2}:[0-9]{2}):[0-9]{2}(\.[0-9]+)?.*/\1_\2/' |
                      sed 's/:/-/g')
            DATETIME_SOURCE="JSON —Ñ–∞–π–ª"
          else
            # –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
            if [[ "$ORIG_NAME" =~ RotorHazard_Export_([0-9]{4})([0-9]{2})([0-9]{2})_([0-9]{2})([0-9]{2}) ]]; then
              DATETIME="${BASH_REMATCH[1]}-${BASH_REMATCH[2]}-${BASH_REMATCH[3]}_${BASH_REMATCH[4]}-${BASH_REMATCH[5]}"
              DATETIME_SOURCE="–∏–º—è —Ñ–∞–π–ª–∞"
            else
              DATETIME=$(date +"%Y-%m-%d_%H-%M")
              DATETIME_SOURCE="—Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è"
            fi
          fi

          # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º caption
          NEW_FILENAME="${DATETIME}_${PROCESSED_CAPTION}.json"
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
          mkdir -p results.jsons
          mv "temp.json" "results.jsons/$NEW_FILENAME"

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          DISPLAY_DATE=$(echo "$DATETIME" | sed 's/_/ /')
          echo "MESSAGE<<EOF" >> $GITHUB_OUTPUT
          echo "‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!" >> $GITHUB_OUTPUT
          echo "–î–∞—Ç–∞: $DISPLAY_DATE" >> $GITHUB_OUTPUT
          echo "–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞—Ç—ã: $DATETIME_SOURCE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "CHAT_ID=$CHAT_ID" >> $GITHUB_OUTPUT
          echo "FILE_NAME=$NEW_FILENAME" >> $GITHUB_OUTPUT
          echo "FILE_PATH=results.jsons/$NEW_FILENAME" >> $GITHUB_OUTPUT

      - name: Commit and push
        run: |
          git config --global user.name "Telegram Bot"
          git config --global user.email "bot@github.com"
          git add .
          git commit -m "Add ${{ steps.process_file.outputs.FILE_NAME }}"
          git push

      - name: Notify user
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ steps.process_file.outputs.CHAT_ID }}
          message: ${{ steps.process_file.outputs.MESSAGE }}

      - name: Notify admin
        if: ${{ steps.process_file.outputs.CHAT_ID != env.TELEGRAM_CHAT_ID }}
        env:
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          message: |
            üì• –ù–æ–≤—ã–π —Ñ–∞–π–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω:
            –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: ${{ steps.process_file.outputs.CHAT_ID }}
            ${{ steps.process_file.outputs.MESSAGE }}
