name: Telegram JSON File Processor

on:
  repository_dispatch:
    types: [telegram_file]

jobs:
  process_file:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Process JSON file
        env:
          EVENT_DATA: ${{ toJson(github.event.client_payload) }}
        run: |
          # Устанавливаем инструменты
          sudo apt-get -y install jq curl

          # Извлекаем метаданные файла
          FILENAME=$(echo "$EVENT_DATA" | jq -r '.message.document.file_name')
          CAPTION=$(echo "$EVENT_DATA" | jq -r '.message.caption // "file"')
          FILE_ID=$(echo "$EVENT_DATA" | jq -r '.message.document.file_id')

          # Скачиваем содержимое файла из Telegram
          TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          FILE_URL=$(curl -s "https://api.telegram.org/bot$TOKEN/getFile?file_id=$FILE_ID" | jq -r '.result.file_path')
          JSON_DATA=$(curl -s "https://api.telegram.org/file/bot$TOKEN/$FILE_URL")

          # Проверяем валидность JSON
          if ! jq -e . >/dev/null 2>&1 <<<"$JSON_DATA"; then
            echo "Ошибка: Невалидный JSON"
            exit 1
          fi

          # 1. Извлекаем дату из структуры JSON
          DATETIME_RAW=$(echo "$JSON_DATA" | jq -r '
            [.. | objects | select(has("start_time_formatted")).start_time_formatted] | first // "null"')

          # 2. Если в JSON нет даты - пробуем извлечь из имени файла
          if [ "$DATETIME_RAW" = "null" ]; then
            if [[ "$FILENAME" =~ RotorHazard_Export_([0-9]{4})([0-9]{2})([0-9]{2})_([0-9]{2})([0-9]{2})([0-9]{2}) ]]; then
              DATETIME_RAW="${BASH_REMATCH[1]}-${BASH_REMATCH[2]}-${BASH_REMATCH[3]} ${BASH_REMATCH[4]}:${BASH_REMATCH[5]}:${BASH_REMATCH[6]}"
            fi
          fi

          # 3. Форматируем дату
          DATETIME=$(date -d "$DATETIME_RAW" +"%Y-%m-%d_%H-%M-%S" 2>/dev/null || date +"%Y-%m-%d_%H-%M-%S")

          # Создаем имя файла
          NEW_FILENAME="${CAPTION}_${DATETIME}.json"
          
          # Сохраняем файл
          mkdir -p results.jsons
          echo "$JSON_DATA" > "results.jsons/$NEW_FILENAME"

          # Коммитим
          git config --global user.name "Telegram Bot"
          git config --global user.email "bot@github.com"
          git add .
          git commit -m "Добавлен файл: $NEW_FILENAME"
          git push

      - name: Notify
        if: success()
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          message: "Файл успешно обработан: $NEW_FILENAME"
