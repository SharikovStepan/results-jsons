name: Telegram Auto-Processor

on:
  repository_dispatch:
    types: [telegram_file]

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Process file
        env:
          EVENT_DATA: ${{ toJson(github.event.client_payload) }}
        run: |
          # Устанавливаем jq
          sudo apt-get install -y jq

          # Извлекаем данные
          FILENAME=$(echo "$EVENT_DATA" | jq -r '.file_name')
          CONTENT=$(echo "$EVENT_DATA" | jq -r '.file_content | fromjson')

          # Форматируем имя файла: подпись_дата.json
          DATETIME=$(date +"%Y-%m-%d_%H-%M-%S")
          NEW_FILENAME="${FILENAME%.*}_$DATETIME.json"

          # Сохраняем файл
          mkdir -p results.jsons
          echo "$CONTENT" > "results.jsons/$NEW_F
