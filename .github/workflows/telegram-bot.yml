- name: Fetch and process file
  run: |
    TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
    
    # Получаем последнее сообщение с файлом
    RESPONSE=$(curl -s "https://api.telegram.org/bot$TOKEN/getUpdates")
    echo "Debug - полный ответ:"
    echo "$RESPONSE" | jq .

    FILE_ID=$(echo "$RESPONSE" | jq -r '.result[-1].message.document.file_id')
    FILE_NAME=$(echo "$RESPONSE" | jq -r '.result[-1].message.document.file_name')
    CAPTION=$(echo "$RESPONSE" | jq -r '.result[-1].message.caption // "file"')

    echo "FILE_ID: $FILE_ID"
    echo "FILE_NAME: $FILE_NAME"
    echo "CAPTION: $CAPTION"

    if [ "$FILE_ID" = "null" ]; then
      echo "Ошибка: Файл не найден в последних сообщениях"
      exit 1
    fi

    # Получаем file_path
    FILE_PATH=$(curl -s "https://api.telegram.org/bot$TOKEN/getFile?file_id=$FILE_ID" | jq -r '.result.file_path')
    if [ "$FILE_PATH" = "null" ]; then
      echo "Ошибка при получении file_path:"
      curl -s "https://api.telegram.org/bot$TOKEN/getFile?file_id=$FILE_ID" | jq .
      exit 1
    fi

    # Скачиваем файл
    curl -o "$FILE_NAME" "https://api.telegram.org/file/bot$TOKEN/$FILE_PATH"
    echo "Файл скачан: $(ls -l "$FILE_NAME")"
