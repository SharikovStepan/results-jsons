name: Telegram JSON Processor

on:
  repository_dispatch:
    types: [telegram_file]  # Триггер при вызове через API

jobs:
  process_file:
    runs-on: ubuntu-latest
    steps:
      # Шаг 1: Получаем код репозитория
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      # Шаг 2: Извлекаем данные из вебхука
      - name: Extract file data
        id: extract_data
        run: |
          # Парсим JSON из события
          FILE_CONTENT='${{ toJson(github.event.client_payload.file_content) }}'
          FILE_NAME=$(echo "$FILE_CONTENT" | jq -r '.message.document.file_name')
          CAPTION=$(echo "$FILE_CONTENT" | jq -r '.message.caption // "uploaded"')

          # Генерируем уникальное имя файла
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          NEW_FILENAME="${CAPTION}_${TIMESTAMP}.json"

          # Сохраняем переменные для следующих шагов
          echo "FILE_NAME=$NEW_FILENAME" >> $GITHUB_OUTPUT
          echo "FILE_CONTENT=$FILE_CONTENT" >> $GITHUB_OUTPUT

      # Шаг 3: Сохраняем файл
      - name: Save JSON file
        run: |
          mkdir -p results.jsons
          echo '${{ steps.extract_data.outputs.FILE_CONTENT }}' > "results.jsons/${{ steps.extract_data.outputs.FILE_NAME }}"
          echo "Файл сохранён: results.jsons/${{ steps.extract_data.outputs.FILE_NAME }}"

      # Шаг 4: Пушим изменения
      - name: Commit and push
        run: |
          git config --global user.name "Telegram Bot"
          git config --global user.email "bot@github.com"
          git add .
          git commit -m "Add ${{ steps.extract_data.outputs.FILE_NAME }}"
          git push

      # Шаг 5: Уведомление в Telegram
      - name: Send confirmation
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          message: |
            ✅ Файл успешно сохранён!
            Имя: ${{ steps.extract_data.outputs.FILE_NAME }}
            Репозиторий: https://github.com/${{ github.repository }}/tree/main/results.jsons
