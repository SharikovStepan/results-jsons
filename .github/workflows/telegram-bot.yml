name: Telegram JSON Processor

on:
  repository_dispatch:
    types: [telegram_file]

jobs:
  process_file:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Process file
        id: process_file
        run: |
          # Устанавливаем инструменты
          sudo apt-get install -y jq

          # Получаем данные из вебхука
          RAW_CONTENT='${{ toJson(github.event.client_payload.file_content) }}'
          CLEAN_CONTENT=$(echo "$RAW_CONTENT" | sed 's/\\"/"/g' | sed 's/^"\|"$//g')
          
          # Извлекаем метаданные
          CAPTION=$(echo "$CLEAN_CONTENT" | jq -r '.message.caption // "file"')
          FILE_ID=$(echo "$CLEAN_CONTENT" | jq -r '.message.document.file_id')
          ORIG_NAME=$(echo "$CLEAN_CONTENT" | jq -r '.message.document.file_name')

          # Скачиваем файл
          FILE_PATH=$(curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/getFile?file_id=$FILE_ID" | jq -r '.result.file_path')
          curl -s -o "temp.json" "https://api.telegram.org/file/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/$FILE_PATH"

          # Пытаемся извлечь дату из содержимого JSON
          DATETIME=$(jq -r '
            [.heats | to_entries[] | 
              .value.rounds | to_entries[] | 
              .value.start_time_formatted
            ] | first // "null"' "temp.json" | 
            sed 's/ /_/g; s/[.:]/-/g; s/\..*//')

          # Если в JSON нет даты, пробуем извлечь из имени файла
          if [ "$DATETIME" = "null" ]; then
            if [[ "$ORIG_NAME" =~ RotorHazard_Export_([0-9]{4})([0-9]{2})([0-9]{2})_([0-9]{2})([0-9]{2})([0-9]{2}) ]]; then
              DATETIME="${BASH_REMATCH[1]}-${BASH_REMATCH[2]}-${BASH_REMATCH[3]}_${BASH_REMATCH[4]}-${BASH_REMATCH[5]}-${BASH_REMATCH[6]}"
            else
              DATETIME=$(date +"%Y-%m-%d_%H-%M-%S")
            fi
          fi

          # Формируем имя файла
          NEW_FILENAME="${CAPTION}_${DATETIME}.json"
          
          # Сохраняем файл
          mkdir -p results.jsons
          mv "temp.json" "results.jsons/$NEW_FILENAME"

          echo "FILE_NAME=$NEW_FILENAME" >> $GITHUB_OUTPUT
          echo "FILE_PATH=results.jsons/$NEW_FILENAME" >> $GITHUB_OUTPUT

      - name: Commit and push
        run: |
          git config --global user.name "Telegram Bot"
          git config --global user.email "bot@github.com"
          git add .
          git commit -m "Add ${{ steps.process_file.outputs.FILE_NAME }}"
          git push

      - name: Notify user
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          message: |
            ✅ Файл успешно сохранён!
            Имя: ${{ steps.process_file.outputs.FILE_NAME }}
            Источник даты: ${DATETIME_SOURCE}
