name: Telegram File Processor

on:
  repository_dispatch:
    types: [telegram_file]

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Process file
        env:
          EVENT_DATA: ${{ toJson(github.event.client_payload) }}
        run: |
          # Устанавливаем инструменты
          sudo apt-get install -y jq curl

echo "Полученные данные:"
echo "FILE_ID: $FILE_ID"
echo "FILE_NAME: $FILE_NAME"
echo "CAPTION: $CAPTION"
echo "Полный ответ getFile:"
curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/getFile?file_id=$FILE_ID" | jq

          # Извлекаем данные из события
          FILE_ID=$(echo "$EVENT_DATA" | jq -r '.message.document.file_id')
          FILE_NAME=$(echo "$EVENT_DATA" | jq -r '.message.document.file_name')
          CAPTION=$(echo "$EVENT_DATA" | jq -r '.message.caption // "file"')

          # 1. Получаем путь к файлу (добавляем обработку ошибок)
          API_RESPONSE=$(curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/getFile?file_id=$FILE_ID")
          FILE_PATH=$(echo "$API_RESPONSE" | jq -r '.result.file_path')
          
          if [ "$FILE_PATH" == "null" ]; then
            echo "Ошибка при получении file_path:"
            echo "$API_RESPONSE"
            exit 1
          fi

          # 2. Скачиваем файл (с проверкой)
          DOWNLOAD_URL="https://api.telegram.org/file/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/$FILE_PATH"
          echo "Пытаюсь скачать файл по URL: $DOWNLOAD_URL"
          
          if ! curl -s -o "$FILE_NAME" "$DOWNLOAD_URL"; then
            echo "Ошибка скачивания файла"
            exit 1
          fi

          # 3. Проверяем, что файл скачался
          if [ ! -f "$FILE_NAME" ]; then
            echo "Файл не был скачан"
            exit 1
          fi

          # 4. Извлекаем дату из имени файла
          if [[ "$FILE_NAME" =~ ([0-9]{4})([0-9]{2})([0-9]{2})_([0-9]{2})([0-9]{2})([0-9]{2}) ]]; then
            DATETIME="${BASH_REMATCH[1]}-${BASH_REMATCH[2]}-${BASH_REMATCH[3]}_${BASH_REMATCH[4]}-${BASH_REMATCH[5]}-${BASH_REMATCH[6]}"
          else
            DATETIME=$(date +"%Y-%m-%d_%H-%M-%S")
          fi

          # 5. Сохраняем файл
          mkdir -p results.jsons
          FINAL_NAME="${CAPTION}_${DATETIME}.json"
          mv "$FILE_NAME" "results.jsons/$FINAL_NAME"

          # Коммитим
          git config --global user.name "Telegram Bot"
          git config --global user.email "bot@github.com"
          git add .
          git commit -m "Add $FINAL_NAME"
          git push

      - name: Notify
        if: success()
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          message: |
            Файл успешно сохранён!
            Имя: $FINAL_NAME
            Размер: $(du -h "results.jsons/$FINAL_NAME" | cut -f1)
