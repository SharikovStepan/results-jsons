name: Telegram JSON Processor

on:
  repository_dispatch:
    types: [telegram_file]

jobs:
  process_file:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Process incoming file
        id: process_file
        run: |
          # Получаем и нормализуем JSON
          RAW_CONTENT='${{ toJson(github.event.client_payload.file_content) }}'
          echo "Normalized content: $RAW_CONTENT"
          
          # Удаляем лишние экранирования (2 замены)
          CLEAN_CONTENT=$(echo "$RAW_CONTENT" | sed 's/\\"/"/g' | sed 's/^"\|"$//g')
          echo "Cleaned content: $CLEAN_CONTENT"
          
          # Парсим данные
          FILE_NAME=$(echo "$CLEAN_CONTENT" | jq -r '.message.document.file_name')
          CAPTION=$(echo "$CLEAN_CONTENT" | jq -r '.message.caption // "uploaded"')
          FILE_ID=$(echo "$CLEAN_CONTENT" | jq -r '.message.document.file_id')
          
          echo "File name: $FILE_NAME"
          echo "Caption: $CAPTION"
          echo "File ID: $FILE_ID"

          # Получаем путь к файлу
          FILE_PATH=$(curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/getFile?file_id=$FILE_ID" | jq -r '.result.file_path')
          echo "File path: $FILE_PATH"
          
          # Скачиваем файл
          curl -s -o "$FILE_NAME" "https://api.telegram.org/file/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/$FILE_PATH"
          
          # Создаем новое имя файла
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          NEW_FILENAME="${CAPTION}_${TIMESTAMP}.json"
          
          # Сохраняем в репозиторий
          mkdir -p results.jsons
          mv "$FILE_NAME" "results.jsons/$NEW_FILENAME"
          
          # Передаем данные между шагами
          echo "FILE_NAME=$NEW_FILENAME" >> $GITHUB_OUTPUT
          echo "FILE_PATH=results.jsons/$NEW_FILENAME" >> $GITHUB_OUTPUT

      - name: Commit and push
        run: |
          git config --global user.name "Telegram Bot"
          git config --global user.email "bot@github.com"
          git add .
          git commit -m "Add ${{ steps.process_file.outputs.FILE_NAME }}"
          git push

      - name: Notify user
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          message: |
            ✅ Файл успешно сохранён!
            Имя: ${{ steps.process_file.outputs.FILE_NAME }}
            Размер: $(stat -c%s "results.jsons/${{ steps.process_file.outputs.FILE_NAME }}") байт
